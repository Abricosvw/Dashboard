# SD Card Troubleshooting Guide

## Проблема
Ошибка сохранения параметров на SD карту с сообщениями:
```
E (8059) SD_CARD: Failed to open file for writing
E (8059) SETTINGS_CONFIG: Failed to save settings to SD card.
```

## Внесенные изменения

### 1. Расширенное логирование
- Добавлено детальное логирование при инициализации SD карты
- Добавлен вывод информации об ошибках с кодами (errno)
- Добавлена проверка состояния точки монтирования

### 2. Проверки перед записью
- Проверка инициализации SD карты перед попыткой записи
- Проверка доступного места на карте
- Проверка валидности указателей и мьютекса

### 3. Диагностическая функция
Добавлена функция `sd_card_diagnostic_test()`, которая выполняет:
- Проверку статуса инициализации
- Вывод информации о карте (имя, емкость, размер сектора)
- Проверку файловой системы (общий/свободный объем)
- Тест записи и чтения файла
- Вывод списка файлов на карте

## Возможные причины проблемы

### 1. SD карта не вставлена
**Проверка**: Убедитесь, что SD карта правильно вставлена в слот

### 2. Неправильное подключение
**Проверка**: Проверьте соединения:
- MISO: GPIO 13
- MOSI: GPIO 11
- CLK: GPIO 12
- CS: GPIO 4

### 3. Проблемы с питанием
**Решение**: Убедитесь, что SD карта получает стабильное питание 3.3В

### 4. Поврежденная файловая система
**Решение**: 
- Попробуйте отформатировать карту в FAT32 на компьютере
- Используйте SD карту объемом до 32 ГБ

### 5. SD карта заполнена
**Проверка**: Диагностика покажет доступное место

### 6. SD карта защищена от записи
**Проверка**: Убедитесь, что переключатель защиты от записи не активен

### 7. Несовместимая SD карта
**Решение**: Попробуйте другую SD карту (желательно Class 10 или выше)

## Диагностика

После прошивки устройства проверьте логи при загрузке. Вы должны увидеть:

1. Сообщение об инициализации SD карты
2. Информацию о карте (название, объем)
3. Результаты диагностического теста
4. Список файлов на карте

Если инициализация не удалась, вы увидите конкретную ошибку.

## Дополнительная отладка

Если проблема сохраняется:

1. Проверьте напряжение на пинах SD карты
2. Попробуйте снизить частоту SPI (в коде можно изменить настройки хоста)
3. Добавьте подтягивающие резисторы 10кОм на линии MISO, MOSI и CS к 3.3В
4. Проверьте качество соединений и длину проводов (должна быть минимальной)

## Команды для мониторинга

```bash
# Мониторинг логов ESP32
idf.py -p COM13 monitor

# Фильтрация логов SD карты
idf.py -p COM13 monitor | grep -E "(SD_CARD|SETTINGS)"
```
